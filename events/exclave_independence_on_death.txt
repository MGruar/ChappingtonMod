namespace = ExclaveIndependence

# on_death: lose land that is not connected to our controlled de jure lands
character_event = {
    id = ExclaveIndependence.1
    hide_window = yes

    is_triggered_only = yes

    only_playable = yes

    trigger = {
        is_landed = yes
        in_revolt = no
        higher_tier_than = BARON   # splitting up multi-mayors would be a separate mod
        is_patrician = no          # keep your vassal patricians and scattered trade cities
        holy_order = no            # keep your scattered SoA castles
        primary_title = { is_vice_royalty = no }

        # Maybe counts should be skipped if they use gavelkind succession?

        # Nomadic vassals are skipped:
        #     Don't especially want to create a zillion clans or give khagan land.
        #     Nomads will eventually be cleaned up somewhat by the khans becoming khagans.
        #     (Due to nomad instability, indep or install khagan faction, or khagan having a child heir.)
        OR = { independent = yes  is_nomadic = no }

        # if our liege is heir to all our titles (e.g. parent or revert-to-appointment), let all titles go to liege normally
        #OR = {
        #    independent = yes
        #    NOT = { heir = { always = yes } }
        #    heir = { ROOT = { liege = { NOT = { character = PREVPREV } } } }
        #    any_demesne_title = { heir = { ... } }
        #    liege = { ... = PREVPREV = { NOT = { any_heir_title = { title = PREVPREV  ???? } } } }
        #}
    }

    immediate = {
        # Destroy any higher titles that ALREADY should not exist, so they do not count toward "connected to de jure lands"
        character_event = { id = ExclaveIndependence.300 }

        # Lose demesne and vassals that are not connected to the de jure lands of our top titles
        character_event = { id = ExclaveIndependence.100 }  # mark   provinces to keep
        set_variable = { which = "infloop"  value = 0 }
        character_event = { id = ExclaveIndependence.200 }  # sweep  outlying holdings & vassals
        character_event = { id = ExclaveIndependence.250 }  # clear  province flags

        # Destroy any higher titles that NOW should not exist, so we can't cheesily offer vassalization to recover distant land
        character_event = { id = ExclaveIndependence.300 }

        # Note: being nice and NOT triggering the De Jure Requirement (GR.1 / ExclaveIndependence.300) for all our heirs.
        # A partition (e.g. gavelkind or feudal elective) SHOULD, in theory, divide titles appropriately so this isn't needed.
        # More importantly, they might already be landed and not appreciate suddenly being DJR'd.
    }
}
